name: Pre-merge Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'Skip pre-commit cache'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.12'

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # For commenting on PRs if needed

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for better pre-commit performance
          fetch-depth: 0

      - name: Detect local testing environment
        id: detect-local
        run: |
          # Detect if running under act or other local testing conditions
          if [[ -n "$ACT" || -n "$ACT_LOCAL_TESTING" || "${{ runner.name }}" == "Hosted Agent" ]]; then
            echo "local_testing=true" >> $GITHUB_OUTPUT
            echo "skip_cache=true" >> $GITHUB_OUTPUT
            echo "ğŸ”§ Local testing environment detected"
          else
            echo "local_testing=false" >> $GITHUB_OUTPUT
            echo "skip_cache=${{ inputs.skip_cache || 'false' }}" >> $GITHUB_OUTPUT
            echo "ğŸš€ GitHub Actions environment detected"
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install uv for faster package installation (following Dockerfile pattern)
          pip install uv

          # Install pre-commit
          pip install pre-commit

          # Install project with development dependencies (following Dockerfile pattern)
          cd owasp_zap_mcp
          # Try uv first, fallback to pip if system is externally managed
          if ! uv pip install --system -e ".[dev]" 2>/dev/null; then
            echo "ğŸ”„ uv --system failed (externally managed Python), falling back to pip..."
            pip install -e ".[dev]"
          fi
          cd ..

      - name: Cache pre-commit hooks
        if: ${{ steps.detect-local.outputs.skip_cache == 'false' }}
        uses: actions/cache@v3
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Install pre-commit hooks
        run: |
          echo "ğŸ“¦ Installing pre-commit hooks..."
          pre-commit install --install-hooks

      - name: Run pre-commit on all files
        if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ğŸ” Running pre-commit on all files (manual trigger)..."
          else
            echo "ğŸ” Running pre-commit on all files (push to main)..."
          fi
          pre-commit run --all-files

      - name: Run pre-commit on changed files
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "ğŸ” Running pre-commit on changed files..."
          # Get the base branch for comparison
          git fetch origin ${{ github.base_ref }}

          # Run pre-commit on files changed in this PR
          pre-commit run --from-ref origin/${{ github.base_ref }} --to-ref HEAD

      - name: Run fast unit tests
        run: |
          echo "ğŸ§ª Running fast unit tests (excluding integration tests)..."
          cd owasp_zap_mcp
          # Run only fast, reliable tests - exclude integration tests that require ZAP
          pytest -v -m "not integration and not slow and not real_world" --tb=short --no-header

      - name: Output summary
        if: always()
        run: |
          echo "ğŸ“‹ Pre-commit Check Summary:"
          echo "  Trigger: ${{ github.event_name }}"
          echo "  Local Testing: ${{ steps.detect-local.outputs.local_testing }}"
          echo "  Python Version: ${{ env.PYTHON_VERSION }}"
          echo "  Cache Skipped: ${{ steps.detect-local.outputs.skip_cache }}"

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "  PR Number: #${{ github.event.number }}"
            echo "  Base Branch: ${{ github.base_ref }}"
            echo "  Head Branch: ${{ github.head_ref }}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "  Branch: ${{ github.ref_name }}"
            echo "  Commit: ${{ github.sha }}"
          fi

          echo ""
          echo "âœ… Pre-commit checks completed!"
